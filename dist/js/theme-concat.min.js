/*
* JAVASCRIPT HELPERS
*/
const callModalbtn = document.querySelector('.callModal-1');
const overlay = document.querySelector('.overlay');
const modal = document.querySelectorAll('.modal');
const modalClose = document.querySelectorAll('.modal__close');

callModalbtn.addEventListener('click', (e) => {

    let path = e.currentTarget.getAttribute('data-path');
    console.log(path);

    modal.forEach((e) => {
        e.classList.remove('modal-opened');
    });

    let modalWindow = document.querySelector(`[data-target="${path}"]`);
    let opacity = 0.4;

    modalWindow.classList.add('modal-opened');

    let timer = setInterval(function () {
        if (opacity >= 1) {
            clearInterval(timer);
        }
        modalWindow.style.opacity = opacity;
        modalWindow.style.filter = 'alpha(opacity=' + opacity * 100 + ")";
        opacity += opacity * 0.1;
    }, 10);

    overlay.classList.add('overlay-visible');
});


overlay.addEventListener('click', (e) => {

    if (e.target == overlay) {
        modal.forEach((e) => {
            e.classList.remove('modal-opened');
        });
        overlay.classList.remove('overlay-visible');
    }
});

modalClose.forEach((e) => {
    e.addEventListener('click', () => {

        modal.forEach((ev) => {
            ev.classList.remove('modal-opened');
        });
        overlay.classList.remove('overlay-visible');

    });
});





const form = document.querySelector('.form__contact');
const name = document.querySelector('input[name=name]');
const email = document.querySelector('input[name=email]');
const btnSubmit = document.querySelector('.btn-submit')


function setErrorFor(input, message) {
    const inputBox = input.parentElement;
    const errorMessage = inputBox.querySelector('.errors');
    inputBox.className = 'form__field error';
    errorMessage.textContent = message;
}

function setSuccessFor(input) {
    const inputBox = input.parentElement;
    const errorMessage = inputBox.querySelector('.errors');
    inputBox.className = 'form__field success';
    errorMessage.textContent = "";
}

function checkInputs() {

    let regExpName = /^[a-zA-Zа-яА-Я'][a-zA-Zа-яА-Я-']+[a-zA-Zа-яА-Я']{3,16}?/;
    let regExpEmail = /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/;
    let nameValue = name.value.trim();
    let emailValue = email.value.trim();

    if (!regExpName.test(nameValue) || nameValue === '') {
        setErrorFor(name, 'Not a valid name');
        return false;
    } 
    else {
        setSuccessFor(name);
    }
    if (!regExpEmail.test(emailValue) || emailValue === '') {
        setErrorFor(email, 'Not a valid email');
        return false;
    } 
    else {
        setSuccessFor(email);
    }

    return true;
}




function serialize(form) {
    if (!form || form.nodeName !== "FORM") {
        return false;
    }
    let i, j, q = [];
    for (i = form.elements.length - 1; i >= 0; i = i - 1) {
        if (form.elements[i].name === "") {
            continue;
        }
        switch (form.elements[i].nodeName) {
            case 'INPUT':
                switch (form.elements[i].type) {
                    case 'text':
                    case 'tel':
                    case 'email':
                    case 'hidden':
                    case 'password':
                    case 'button':
                    case 'reset':
                    case 'submit':
                        q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].value));
                        break;
                    case 'checkbox':
                    case 'radio':
                        if (form.elements[i].checked) {
                            q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].value));
                        }
                        break;
                }
                break;
            case 'file':
                break;
            case 'TEXTAREA':
                q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].value));
                break;
            case 'SELECT':
                switch (form.elements[i].type) {
                    case 'select-one':
                        q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].value));
                        break;
                    case 'select-multiple':
                        for (j = form.elements[i].options.length - 1; j >= 0; j = j - 1) {
                            if (form.elements[i].options[j].selected) {
                                q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].options[j].value));
                            }
                        }
                        break;
                }
                break;
            case 'BUTTON':
                switch (form.elements[i].type) {
                    case 'reset':
                    case 'submit':
                    case 'button':
                        q.push(form.elements[i].name + "=" + encodeURIComponent(form.elements[i].value));
                        break;
                }
                break;
        }
    }
    return q.join("&");
}

form.addEventListener('submit', (event) => {
    event.preventDefault();
    let isValidate = checkInputs();
    
    if (isValidate){
        console.log(isValidate);
        document.querySelector('.modal').classList.remove('modal-opened');
        document.querySelector('.overlay').classList.remove('overlay-visible');

        console.log(serialize(form));
        // alert('Jnghf');

    }
    if (document.querySelector('.modal').className = "modal modal-2") {
        document.querySelector('.modal').classList.add('modal-opened');
        document.querySelector('.overlay').classList.add('overlay-visible');
    }

});

//"use strict";

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form');
    form.addEventListener('submit', formSend);

    async function formSend(e) {
        e.preventDefault();

        let error = formValidate(form);
        let formData = new FormData(form);

        console.log('error: '  + error);
        if (error === 2){
            console.log('435345');
            form.classList.add('sending');
            
            /*let response = await fetch('sendmail.php', {
                method: 'POST',
                body: formData
            });
            if (response.ok){
                let result = await response.json();
                alert(result.message);
                form.reset();
                form.classList.remove('sending');
            } else {
                alert('Ошибка');
                form.classList.remove('sending');
            }*/
        } else {
            alert('Заполните обязательные поля');
        }
    }

    function formValidate(form){
        let error = 0;
        let formReq = document.querySelectorAll('.required-field');

        for (let i = 0; i < formReq.length; i++){
            const input = formReq[i];
            formRemoveError(input);

            //if(input.classList.contains('email')) {
            //    if (emailTest(input)){
            //        formAddError(input);
            //        error++;
            //    }

            //} 
            //else if(input.getAttribute('type') === 'checkbox' && input.checked === false){
            //    formAddError(input);
            //    error++;
            //} 
            //else {
                if (input.value === ''){
                    formAddError(input);
                    error++;
                }
            //}
        }
        return error;
    }

    function formAddError(input){
        //input.parentElement.classList.add('error');
        input.classList.add('error');
    }
    function formRemoveError(input){
        //input.parentElement.classList.remove('error');
        input.classList.remove('error');
    }

    //function nameTest(input){
    //     let regExpName = /^[a-zA-Zа-яА-Я'][a-zA-Zа-яА-Я-']+[a-zA-Zа-яА-Я']{3,16}?/;
    //     return regExpName.test(input.value);
    //}

    //function emailTest(input){
    //     let regExpEmail = /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/;
    //     return regExpEmail.test(input.value);
    //}

});

// проставляем title у ссылок изображений
// инициализируем (подключаем) либу фотогалереи
// (function($){
//     window.lightGallery = function(block, a) {
//         $(block).find(a).each(function() {
//             $(this).attr('data-sub-html', $(this).find('img').attr('title'));
//         });
//         $(block).lightGallery({
//             selector: a,
//             download: false,
//             fullScreen: false,
//             zoom: false,
//             share: false,
//             thumbnail: true
//         });
//     }
// })(jQuery);


